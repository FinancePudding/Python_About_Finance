# 数据预处理

## 1.市值行业中性化

### 1.1 简要介绍

从变量之间的相关性还能够引出业界的另一种常见处理方式——正交化（或中性化）。考虑两个相关的变量A和B，且变量A是一个优秀的预测变量，而变量B虽然能解释股票收益率的波动但通过它选股却无法获得超额收益。这二者之间的相关性使得用A预测股票收益率时会受到B的影响。由于B对于预测收益率没有贡献，因此人们希望把它对A的干扰排除，这时就会对A进行正交化处理。

### 1.2实际应用

在**股票截面**上以B作为解释变量，以A作为被解释变量进行回归，得到A的残差并用残差代替 原始变量A作为预测变量。由于A的残差与B正交，因此利用它预测收益率时便不再 受到B的影响。在业界的因子投资中，通常使用**行业哑变量**和市值变量作为风险因子变量，将原始预测变量进行正交化处理，得出的残差被称为行业和市值中性的预测变量。

### 1.3 行业虚拟变量

为了剔除多重共线性的影响，需要去除一个行业虚拟变量。具体解释见 [Chat-GPT问答](https://chatgpt.com/share/095dcf57-bd4d-487d-8a66-4c96ecd4e6c4)

### 1.4 回归基础

一般回归分为截面回归、时序回归、面板数据回归。截面回归在因子分析过程中常常用来进行市值行业中性化处理，时序回归常用来计算CAPM模型的β因子计算，面板数据回归在日常写论文中经常用到，推荐多关注学习一下，可以参考[视频](https://www.bilibili.com/video/BV1Kg411o7ot/?spm_id_from=333.788&vd_source=f96a96669fd5529b597d07af437c4f08)


## 2.异常值处理

剔除异常值的方法较多，常见的有缩尾法、三倍标准差法和中位数法。

### 2.1 缩尾法（Winsorization）

> **a.简介：**
> 
> * 缩尾法（winsorization）最简单也最常见，是学术论文中应用最为普遍的方法。缩尾法又被称为固定比例法，即按照变量从小到大进行排序，将小于 p% 分位数和大于 1-p% 分位数的指标值剔除（或者用临界点值替代）。
> 
> **b.缺点：**
> 
> * 首先，对于某些指标（如异常换手率），异常值并不常见，强行使用缩尾法会将原本合理的数据删除。
> * 其次，对于异常值很多的指标，如果临界点取得较小，会造成异常值剔得不干净。
> * 最后，对于分布不对称的指标，异常大和异常小数量差异较大，因而在分布的左尾和右尾采用同样百分比确定临界值也不恰当。

### 2.2 三倍标准差法（Three-Sigma Rule）

> **a.简介：**
> 
> * 在概率分布中，标准差反映了分布的离散程度。对一个满足正态分布的随机变量而言，其取值落入均值左右一倍标准差内的概率是 68.3%，落在两倍标准差内的概率是 95.4%，落在三倍标准差内的概率是 99.7%。因此随机变量的取值落在三倍标准差之外的概率非常小，不足 0.3%。受到上述启发，均值方差法将距离均值超过 3σ 视为小概率事件，若取值满足这一条件，则被视为异常值
> 
> **b.缺点：**
> 
> * 首先，当数据偏离正态分布较大时，均值方差方法可能就会出现偏差，难以达到理想的效果。
> * 其次，由于均值和方差在计算时本身也会用到全部样本数据，即异常值会影响均值和标准差的计算。
> * 最后，若部分异常值特别大，导致σ值很大，则距离均值±3σ的范围就会很宽，造成看起来是异常值但却无法识别到的窘境。

### 2.3 绝对中位差（Median Absolute Deviation, MAD）

> **a.简介**
> 
> * 绝对中位差法，考虑到样本均值和标准差不够稳健，容易受到异常值的影响，因此将均值用中位数代替，将标准差用绝对中位差代替，这样就得到了MAD法。
> * 中位数（Median）又称中值，是按顺序排列的一组数据中居于中间位置的数，它不受数据分布的极大或极小值影响。令 $X_i$ 代表股票 i 的某预测变量的取值，令 $X_m$ 代表 $X_i$ 的中位数，则绝对中位差（MAD）的定义为：
> 
> **b.计算方法**
> 
> * 中位数（Median）又称中值，是按顺序排列的一组数据中居于中间位置的数，它不受数据分布的极大或极小值影响。令 $X_i$ 代表股票 i 的某预测变量的取值，令 $X_m$ 代表 $X_i$ 的中位数，则绝对中位差（MAD）的定义为：

$$
MAD = \text{median}(|X_i - X_m|)
$$

> * 该式的含义是，用原数据减去中位数后得到新数据序列，然后将该序列取绝对值后再找出中位数即为 MAD。
> * 一般来说，在描述数据离散程度时，标准差和 MAD 并非 1 比 1 的关系，因此需要给 MAD 乘以一个系数。考虑到当随机变量服从正态分布时，1 标准差约为 1.4826 倍的绝对中位差，因此将式中的 MAD 乘以系数 1.4826 得到最终的偏离幅度，记为 MAD_e。对于任意 $X_i$，如果它偏离中位数 $X_m$ 的距离（左右两侧）超过 $3 \times MAD_e$，则被称为异常值，需剔除或用 $X_m \pm 3 \times MAD_e$ 之一代替。
> 
> **c.优势与缺点**
> 
> * 优势：相比于均值和标准差，无论是中位数和绝对中位差都更能适应数据中的异常值，少量的异常值不会干扰到异常值的识别，从而提高异常值的识别准确度。
>   缺点：当异常值较多时，这种方法也仍然会出现识别盲区，无法排除所有异常值。

参考文献：

[《因子投资：方法与实践》](https://www.factorwar.com/) 作者：石川，刘洋溢，连祥斌 -- 7.1.4 收益率预测 -- 2.剔除预测变量异常值

